flowchart TD
    Start([START]) --> Init[INIT<br/>Initialize variables:<br/>line=NULL, len=0<br/>last_status=0<br/>line_count=0]
    Init --> Loop{LOOP<br/>while 1}
    
    Loop -->|continue| Interactive{INTERACTIVE?<br/>isatty STDIN_FILENO}
    
    Interactive -->|YES| PrintPrompt[PRINT PROMPT<br/>write PROMPT]
    Interactive -->|NO| ReadLine[READ LINE<br/>getline line, len, stdin]
    PrintPrompt --> ReadLine
    
    ReadLine --> CheckEOF{EOF / ERROR?<br/>nread == -1}
    
    CheckEOF -->|YES| CheckInteractive2{INTERACTIVE?<br/>isatty STDIN_FILENO}
    CheckInteractive2 -->|YES| PrintNewline[PRINT NEWLINE<br/>write \n]
    CheckInteractive2 -->|NO| End([END<br/>return last_status])
    PrintNewline --> End
    
    CheckEOF -->|NO| IncLineCount[LINE COUNT<br/>line_count++]
    IncLineCount --> TrimNewline[TRIM NEWLINE<br/>if line nread-1 == \n<br/>replace with \0]
    
    TrimNewline --> CheckEmpty{EMPTY LINE?<br/>strlen line == 0}
    CheckEmpty -->|YES| Loop
    CheckEmpty -->|NO| Parse[PARSE<br/>argc = parse_line<br/>line, argv, MAX_ARGS]
    
    Parse --> CheckArgc{argc == 0?}
    CheckArgc -->|YES| Loop
    CheckArgc -->|NO| CheckBuiltin{BUILTIN?<br/>is_builtin argv 0}
    
    CheckBuiltin -->|YES| ExecBuiltin[EXECUTE BUILTIN<br/>status = execute_builtin<br/>argv 0]
    ExecBuiltin --> CheckExitSignal{status ==<br/>EXIT_SHELL?}
    CheckExitSignal -->|YES| FreeAndEnd[FREE LINE<br/>free line]
    FreeAndEnd --> ReturnStatus([RETURN<br/>last_status])
    CheckExitSignal -->|NO| UpdateStatus[UPDATE STATUS<br/>last_status = status]
    UpdateStatus --> Loop
    
    CheckBuiltin -->|NO| FindCmd[FIND COMMAND<br/>command_path =<br/>find_command argv 0]
    
    FindCmd --> CheckFound{FOUND?<br/>command_path<br/>!= NULL}
    
    CheckFound -->|NO| NotFound[NOT FOUND ERROR<br/>fprintf stderr<br/>prog_name : line_count :<br/>command : not found]
    NotFound --> SetStatus127[STATUS<br/>last_status = 127]
    SetStatus127 --> Loop
    
    CheckFound -->|YES| Fork[FORK<br/>pid = fork]
    
    Fork --> CheckFork{FORK FAILED?<br/>pid == -1}
    CheckFork -->|YES| ForkError[PERROR<br/>perror prog_name]
    ForkError --> SetStatus1[STATUS<br/>last_status = 1]
    SetStatus1 --> Loop
    
    CheckFork -->|NO| IsChild{CHILD?<br/>pid == 0}
    
    IsChild -->|YES| Execve[EXECUTE<br/>execve command_path<br/>argv, environ]
    Execve --> ExecCheck{EXECVE FAILED?<br/>return == -1}
    ExecCheck -->|YES| ExecError[PERROR<br/>perror prog_name]
    ExecError --> Exit126[EXIT<br/>exit 126]
    
    IsChild -->|NO| Waitpid[WAITPID<br/>waitpid pid, &status, 0]
    
    Waitpid --> WaitCheck{WAITING FAILED?<br/>waitpid == -1}
    WaitCheck -->|YES| WaitError[PERROR<br/>perror prog_name]
    WaitError --> SetStatusWait1[STATUS<br/>last_status = 1]
    SetStatusWait1 --> Loop
    
    WaitCheck -->|NO| ExitNormally{EXIT NORMALLY?<br/>WIFEXITED status}
    
    ExitNormally -->|YES| GetExitStatus[STATUS<br/>last_status =<br/>WEXITSTATUS status]
    GetExitStatus --> Loop
    
    ExitNormally -->|NO| SetStatusAbnormal[STATUS<br/>last_status = 1]
    SetStatusAbnormal --> Loop
    
    style Start fill:#90EE90
    style End fill:#FFB6C1
    style ReturnStatus fill:#FFB6C1
    style Loop fill:#87CEEB
    style CheckBuiltin fill:#FFD700
    style CheckFound fill:#FFD700
    style CheckEOF fill:#FFD700
    style IsChild fill:#FFD700
